<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet type="text/xsl" ?>
<casaxml xmlns="http://casa.nrao.edu/schema/psetTypes.html"
xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
xsi:schemaLocation="http://casa.nrao.edu/schema/casa.xsd
file:///opt/casa/code/xmlcasa/xml/casa.xsd">

<task type="function" name="h_applycal" category="pipeline">
<shortdescription>Apply the calibration(s) to the data</shortdescription>
<description>
Apply the calibration to the data.
</description>
<input>
    <param type="stringArray" name="vis" subparam="true">
	<description>List of input measurement sets</description>
	<value></value>
   </param>

   <param type="string" name="field" subparam="true">
	<description>Set of data selection field names or ids</description>
	<value></value>
   </param>

   <param type="string" name="intent" subparam="true">
	<description>Set of data selection observing intents</description>
	<value></value>
   </param>

   <param type="string" name="spw" subparam="true">
	<description>Set of data selection spectral window/channels</description>
	<value></value>
   </param>

   <param type="string" name="antenna" subparam="true">
	<description>Set of data selection antenna ids</description>
	<value></value>
   </param>

    <param type="string" name="applymode">
        <description>Calibration mode: ""="calflagstrict","calflag","calflagstrict","trial","flagonly","flagonlystrict", or "calonly"</description>
        <value></value>
        <allowed kind="enum">
            <value></value>
            <value>calflag</value>
            <value>calflagstrict</value>
            <value>trial</value>
            <value>flagonly</value>
            <value>flagonlystrict</value>
            <value>calonly</value>
        </allowed>
    </param>

    <param type="boolArray" name="calwt" subparam="true">
	<description>Calibrate the weights as well as the data</description>
	<value>True</value>
    </param>

    <param type="bool" name="flagbackup" subparam="true">
	<description>Backup the flags before the apply</description>
	<value type="bool">True</value>
    </param>

    <param type="bool" name="flagsum">
	<description>Compute before and after flagging summary statistics</description>
	<value type="bool">True</value>
    </param>

    <param type="bool" name="flagdetailedsum" subparam="true">
	<description>Compute before and after flagging summary statistics</description>
	<value type="bool">False</value>
    </param>

    <param type="string" name="pipelinemode">
	<description>The pipeline operating mode</description>
	<value>automatic</value>
	<allowed kind="enum">
	    <value>automatic</value>
	    <value>interactive</value>
	    <value>getinputs</value>
	</allowed>
    </param>

    <param type="bool" name="dryrun" subparam="true">
	<description>Run task (False) or display the command(True)</description>
	<value type="bool">False</value>
    </param>

    <param type="bool" name="acceptresults" subparam="true">
	<description>Automatically accept results into the context</description>
	<value type="bool">True</value>
    </param>

    <constraints>
        <when param="pipelinemode">
	    <equals type="string" value="automatic" />
	    <equals type="string" value="interactive">
	        <default param="vis"><value type="stringArray"></value></default>
	        <default param="field"><value type="string"></value></default>
	        <default param="intent"><value type="string"></value></default>
	        <default param="spw"><value type="string"></value></default>
		<default param="antenna"><value type="string"></value></default>
	        <default param="calwt"><value type="boolArray">True</value></default>
	        <default param="flagbackup"><value type="bool">True</value></default>
	        <default param="dryrun"><value type="bool">False</value></default>
	        <default param="acceptresults"><value type="bool">True</value></default>
	    </equals>
	    <equals type="string" value="getinputs">
	        <default param="vis"><value type="stringArray"></value></default>
	        <default param="field"><value type="string"></value></default>
	        <default param="intent"><value type="string"></value></default>
	        <default param="spw"><value type="string"></value></default>
		<default param="antenna"><value type="string"></value></default>
	        <default param="calwt"><value type="boolArray">True</value></default>
	        <default param="flagbackup"><value type="bool">True</value></default>
	    </equals>
        </when>
        <when param="flagsum">
	    <equals type="bool" value="True">
	        <default param="flagdetailedsum"><value type="bool">False</value></default>
	    </equals>
	    <equals type="bool" value="False">
	    </equals>
        </when>
    </constraints>
</input>

<output>
    <param type="any" name="results">
        <description>The output results object</description>
        <any type="variant"/>
        <value></value>
    </param>
</output>
<returns type="void"/>

<example>

Apply precomputed calibrations to the data.

---- pipeline parameter arguments which can be set in any pipeline mode

applymode -- Calibration apply mode 
    ''='calflagstrict': calibrate data and apply flags from solutions using
        the strict flagging convention
    'trial': report on flags from solutions, dataset entirely unchanged
    'flagonly': apply flags from solutions only, data not calibrated
    'calonly': calibrate data only, flags from solutions NOT applied
    'calflagstrict':
    'flagonlystrict':same as above except flag spws for which calibration is
        unavailable in one or more tables (instead of allowing them to pass
        uncalibrated and unflagged)
   default: ''

flagsum -- Compute before and after flagging statistics summaries. 
   default: True

flagdetailedsum -- Compute detailed before and after flagging statistics summaries
   if flagsum is True. 
   default: False

pipelinemode -- The pipeline operating mode. In 'automatic' mode the pipeline
   determines the values of all context defined pipeline inputs automatically.
   In interactive mode the user can set the pipeline context defined parameters
   manually.  In 'getinputs' mode the user can check the settings of all
   pipeline parameters without running the task.
   default: 'automatic'.


---- pipeline context defined parameter arguments which can be set only in
'interactive mode'

vis -- The list of input measurement sets. Defaults to the list of measurement
    sets in the pipeline context.
    default: []
    example: ['X227.ms'] 

field -- A string containing the list of field names or field ids to which
    the calibration will be applied. Defaults to all fields in the pipeline
    context.
    default: '' 
    example: '3C279', '3C279, M82'

intent -- A string containing a the list of intents against which the 
    selected fields will be matched. Defaults to all supported intents
    in the pipeline context.
    default: ''
    example: '*TARGET*'

spw -- The list of spectral windows and channels to which the calibration
    will be applied. Defaults to all science windows in the pipeline
    context.
    default: '' 
    example: '17', '11, 15'

antenna -- The list of antennas to which the calibration will be applied.
    Defaults to all antennas. Not currently supported.


--- pipeline task execution modes
dryrun -- Run the commands (True) or generate the commands to be run but
   do not execute (False).
   default: False

acceptresults -- Add the results of the task to the pipeline context (True) or
   reject them (False).
   default: True

Output:

results -- If pipeline mode is 'getinputs' then None is returned. Otherwise
    the results object for the pipeline task is returned

Description

hif_applycal applies the precomputed calibration tables stored in the pipeline
context to the set of visibility files using predetermined field and
spectral window maps and default values for the interpolation schemes.

Users can interact with the pipeline calibration state using the tasks
hif_export_calstate and hif_import_calstate.

Issues

There is some discussion about the appropriate values of calwt. Given 
properly scaled data, the correct value should be the CASA default of True.
However at the current time ALMA is suggesting that calwt be set to True for
applying observatory calibrations, e.g. antenna positions, WVR, and system
temperature corrections, and to False for applying instrument calibrations,
e.g. bandpass, gain, and flux.


Examples

1. Apply the calibration to the target data

hif_applycal (intent='TARGET')

</example> 

</task>
</casaxml>
